package com.gasmonitor.service.device;import com.gasmonitor.dao.DeviceRepository;import com.gasmonitor.entity.Device;import com.gasmonitor.pros.HazelCastPros;import com.gasmonitor.service.device.api.DeviceService;import com.hazelcast.core.HazelcastInstance;import com.hazelcast.core.IMap;import org.slf4j.Logger;import org.slf4j.LoggerFactory;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.stereotype.Service;import org.springframework.transaction.annotation.Transactional;import java.util.Date;import java.util.List;/** * Created by saplmm on 2017/7/10. */@Servicepublic class DeviceServiceImp implements DeviceService {    private Logger log = LoggerFactory.getLogger(DeviceServiceImp.class);    @Autowired    private DeviceRepository deviceRepository;    @Autowired    private HazelcastInstance hazelcastInstance;    @Autowired    private HazelCastPros hazelCastPros;    @Override    @Transactional    public Device addDevice(Device device, long tenantId) {        //1，把数据保存到数据库        device.setId(null);        device.setCreated(new Date());        device.setTokenId("");        log.info("保存之前的设备:{}", device);        device = deviceRepository.save(device);        log.info("保存之后的设备:{}", device);        //2,更新hazelcast的map        IMap<String, String> map = hazelcastInstance.getMap(hazelCastPros.getMaptenant());        map.set(device.getHardwareId(), tenantId + "");        return device;    }    @Override    public List<Device> findDeviceBySiteId(long siteId) {        //1,找到根节点        List<Device> parent = deviceRepository.findBySiteIdAndParent(siteId, (long) 0);        //找子节点        for (Device d : parent) {            d.setChildren(deviceRepository.findBySiteIdAndParent(siteId, d.getId()));        }        return parent;    }}